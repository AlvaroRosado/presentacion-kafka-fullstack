{% extends 'base.html.twig' %}

{% block title %}Comparativa de Mercado{% endblock %}

{% block body %}
    <style>
        /* Ajustamos el body para que no tenga m√°rgenes ni padding base */
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background: #FAFAFA;
            color: #1F2937;
            height: 100vh; /* Asegura que el body ocupe todo el alto del iframe */
            overflow: hidden; /* Evita doble scroll */
        }

        /* NUEVO: Contenedor principal que manejar√° el scroll */
        .main-scroll-container {
            height: 100%; /* Ocupa toda la altura del body */
            overflow-y: auto; /* Permite scroll vertical si el contenido es largo */
            padding: 1rem; /* Movemos el padding aqu√≠ */
            box-sizing: border-box; /* Asegura que el padding no afecte la altura total */
            /* Estilo opcional para la barra de scroll */
            scrollbar-width: thin;
            scrollbar-color: #CBD5E1 transparent;
        }

        /* Estilos para scrollbar en Webkit (Chrome, Safari) */
        .main-scroll-container::-webkit-scrollbar { width: 6px; }
        .main-scroll-container::-webkit-scrollbar-track { background: transparent; }
        .main-scroll-container::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 3px; }

        /* Utilidades extra (se mantienen igual) */
        .mr-card {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: transform 0.1s ease-in-out;
        }
        .mr-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .mr-btn {
            background: #4F46E5;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        .mr-btn:hover { background: #4338ca; }
    </style>

    {# Envolvemos todo el contenido en el nuevo contenedor con scroll #}
    <div class="main-scroll-container">
        <div class="space-y-4">

            {# CABECERA: TU VEH√çCULO (Referencia) #}
            <div class="rounded-lg p-4 shadow-sm" style="background:#EFF6FF; border:1px solid #DBEAFE;">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-xs text-blue-600 font-bold uppercase tracking-wide opacity-80" style="margin:0 0 4px 0;">Tu veh√≠culo (Referencia)</p>
                        <p class="font-semibold text-gray-800" style="margin:0;">
                            {{ searched.title|default('Veh√≠culo actual') }}
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="font-bold text-lg text-blue-900">
                            {{ searched.price|number_format(0, ',', '.') }} ‚Ç¨
                        </span>
                    </div>
                </div>
            </div>

            {# LISTADO DE RESULTADOS #}
            <div style="display: flex; flex-direction: column; gap: 12px;">
                {% for car in cars %}
                    {% set diff = car.price - searched.price %}
                    {% set isCheaper = diff < 0 %}

                    <div class="mr-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">

                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: #F3F4F6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                    <img src="{{ car.img }}" alt="{{ car.title }}" style="max-width: 100%;">
                                </div>

                                <div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="font-weight: 700; font-size: 14px; color: #111827;">
                                            {{ car.title }}
                                        </span>
                                        {% if car.tag %}
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded"
                                                  style="background: #F3F4F6; color: #4B5563; font-size: 10px; border: 1px solid #E5E7EB;">
                                                {{ car.tag }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <p style="margin: 2px 0 0 0; font-size: 12px; color: #6B7280;">
                                        {{ car.year }} ¬∑ {{ car.source }} ¬∑ {{ (car.km/1000)|round }} km
                                    </p>
                                </div>
                            </div>

                            <div style="text-align: right;">
                                <p style="font-weight: 800; font-size: 16px; margin: 0; color: #1F2937;">
                                    {{ car.price|number_format(0, ',', '.') }} ‚Ç¨
                                </p>

                                <p style="margin: 2px 0 6px 0; font-size: 11px; font-weight: 600;
                                    color: {% if isCheaper %}#059669{% else %}#DC2626{% endif %};">
                                    {% if isCheaper %}
                                        {{ diff|number_format(0, ',', '.') }} ‚Ç¨ vs tuyo
                                    {% else %}
                                        +{{ diff|number_format(0, ',', '.') }} ‚Ç¨ vs tuyo
                                    {% endif %}
                                </p>

                                <a href="{{ car.url }}" target="_blank" class="mr-btn">
                                    Ver
                                </a>
                            </div>
                        </div>
                    </div>

                {% else %}
                    <div class="text-center p-8 rounded-xl border-2 border-dashed border-gray-200" style="color: #6B7280;">
                        <div style="font-size: 30px; margin-bottom: 10px;">üîç</div>
                        <p style="margin:0; font-weight: 500;">No se encontraron ofertas similares.</p>
                    </div>
                {% endfor %}
            </div>

            <div class="text-center mt-6 mb-2">
                <p class="text-xs text-gray-400">
                    Datos extra√≠dos en tiempo real de portales p√∫blicos.
                </p>
            </div>

        </div>
    </div>
{% endblock %}
